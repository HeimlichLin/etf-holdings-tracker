<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF 00981A æŒå€‰è¿½è¹¤ç³»çµ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/apple-style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-chart-line" style="color: var(--accent-primary);"></i> ETF 00981A æŒå€‰è¿½è¹¤ç³»çµ±</h1>
        </header>
        
        <!-- Status Card -->
        <div class="bento-card area-status">
            <div class="card-title">
                <span><i class="fas fa-server"></i> ç³»çµ±ç‹€æ…‹</span>
            </div>
            <div class="status-indicator" id="healthButton" onclick="toggleHealthDetails()" style="cursor: pointer;">
                <div class="status-dot" id="healthStatusDot"></div>
                <span class="status-text" id="healthStatusText">è¼‰å…¥ä¸­</span>
                <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 0.8rem; opacity: 0.5;"></i>
            </div>
            <div class="health-details" id="healthDetails"></div>
        </div>
        
        <!-- Actions Card -->
        <div class="bento-card area-actions">
            <div class="card-title">
                <span><i class="fas fa-terminal"></i> å¿«é€Ÿæ“ä½œ</span>
            </div>
            <div class="action-group">
                <button class="btn btn-primary" onclick="fetchData()"><i class="fas fa-sync-alt"></i> æŠ“å–æœ€æ–°</button>
                <button class="btn btn-success" onclick="getLatest()"><i class="fas fa-clipboard-list"></i> æœ€æ–°æŒå€‰</button>
                <button class="btn btn-warning" onclick="previewCleanup()"><i class="fas fa-trash-alt"></i> æ¸…ç†é è¦½</button>
                <button class="btn btn-danger" onclick="confirmCleanup()" style="display:none;" id="confirmCleanupBtn"><i class="fas fa-exclamation-triangle"></i> ç¢ºèªæ¸…ç†</button>
            </div>
        </div>
        
        <!-- Date & Compare Card -->
        <div class="bento-card area-date">
            <div class="card-title" onclick="toggleSection('dateSection')" style="cursor: pointer;">
                <span><i class="fas fa-calendar-alt"></i> æ—¥æœŸæŸ¥è©¢</span>
                <i class="fas fa-chevron-down" id="dateSectionIcon" style="transition: transform 0.3s;"></i>
            </div>
            <div id="dateSection" style="display: none; margin-top: 15px;">
                <div class="action-group" style="flex-direction: column;">
                    <select id="dateSelect" style="width: 100%; margin-bottom: 10px;"></select>
                    <button class="btn btn-outline" onclick="getByDate()" style="width: 100%; justify-content: center;"><i class="fas fa-search"></i> æŸ¥è©¢</button>
                </div>
            </div>
        </div>
        
        <!-- Compare Range Card -->
        <div class="bento-card area-compare">
            <div class="card-title" onclick="toggleSection('compareSection')" style="cursor: pointer;">
                <span><i class="fas fa-exchange-alt"></i> å€é–“æ¯”è¼ƒ</span>
                <i class="fas fa-chevron-down" id="compareSectionIcon" style="transition: transform 0.3s;"></i>
            </div>
            <div id="compareSection" style="display: none; margin-top: 15px;">
                <div class="compare-controls" style="flex-direction: column; align-items: stretch;">
                    <div class="date-range-picker" style="justify-content: space-between;">
                        <span class="label" style="color: var(--text-secondary); font-size: 0.8rem;">èµ·å§‹</span>
                        <select id="startDateSelect"></select>
                    </div>
                    <div style="text-align: center; color: var(--text-secondary); margin: 5px 0;"><i class="fas fa-arrow-down"></i></div>
                    <div class="date-range-picker" style="justify-content: space-between;">
                        <span class="label" style="color: var(--text-secondary); font-size: 0.8rem;">çµæŸ</span>
                        <select id="endDateSelect"></select>
                    </div>
                    <button id="compareBtn" class="btn btn-primary" onclick="compareRange()" style="margin-top: 10px; justify-content: center;"><i class="fas fa-chart-bar"></i> é–‹å§‹æ¯”è¼ƒ</button>
                </div>
            </div>
        </div>
        
        <!-- Result Card -->
        <div class="bento-card area-result">
            <div class="card-title">
                <span><i class="fas fa-file-code"></i> åŸ·è¡Œçµæœ</span>
                <button class="btn btn-outline" onclick="closeResult()" style="padding: 4px 12px; font-size: 0.8rem;"><i class="fas fa-times"></i> é—œé–‰</button>
            </div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="text-align: center; color: var(--text-secondary);">è™•ç†ä¸­...</p>
            </div>
            <div id="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        async function api(endpoint, method = 'GET') {
            showLoading(true);
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, { method });
                const data = await response.json();
                return data;
            } catch (error) {
                return { success: false, message: error.message };
            } finally {
                showLoading(false);
            }
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const resultArea = document.querySelector('.area-result');
            
            if (show) {
                resultArea.style.display = 'flex';
                resultArea.classList.add('active');
                loading.classList.add('active');
                document.getElementById('result').style.display = 'none';
                resultArea.scrollIntoView({ behavior: 'smooth', block: 'end' });
            } else {
                loading.classList.remove('active');
                document.getElementById('result').style.display = 'block';
            }
        }

        function showResult() {
            const resultArea = document.querySelector('.area-result');
            resultArea.style.display = 'flex';
            resultArea.classList.add('active');
        }

        function closeResult() {
            const resultArea = document.querySelector('.area-result');
            resultArea.style.display = 'none';
            resultArea.classList.remove('active');
        }
        
        function formatJson(obj) {
            return JSON.stringify(obj, null, 2);
        }
        
        function renderResult(data) {
            document.getElementById('result').textContent = formatJson(data);
            showResult();
        }
        
        function toggleHealthDetails() {
            const details = document.getElementById('healthDetails');
            details.classList.toggle('show');
        }

        function toggleSection(id) {
            const section = document.getElementById(id);
            const icon = document.getElementById(id + 'Icon');
            const isHidden = section.style.display === 'none';
            
            section.style.display = isHidden ? 'block' : 'none';
            if (icon) {
                icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        }
        
        async function checkHealth() {
            // Don't show loading for background health check
            try {
                const response = await fetch(`${API_BASE}/system/health`);
                const data = await response.json();
                
                const dot = document.getElementById('healthStatusDot');
                const text = document.getElementById('healthStatusText');
                const details = document.getElementById('healthDetails');
                
                if (data.success && data.data) {
                    const health = data.data;
                    const statusClass = health.status === 'UP' ? 'up' : 
                                    health.status === 'DEGRADED' ? 'degraded' : 'down';
                    
                    // Update dot and text
                    dot.className = `status-dot ${statusClass}`;
                    text.textContent = health.status;
                    
                    // Build details HTML
                    let detailsHtml = `
                        <table>
                            <tr><th>å…ƒä»¶</th><th>ç‹€æ…‹</th><th>è¨Šæ¯</th></tr>
                            ${Object.entries(health.components || {}).map(([key, comp]) => `
                                <tr>
                                    <td>${comp.name || key}</td>
                                    <td><span class="status-dot ${comp.status === 'UP' ? 'up' : 'down'}" style="display:inline-block; width:8px; height:8px; margin-right:5px;"></span>${comp.status}</td>
                                    <td>${comp.message || '-'}</td>
                                </tr>
                            `).join('')}
                            <tr><td>ç¸½è¨˜éŒ„æ•¸</td><td colspan="2">${health.totalRecords}</td></tr>
                            <tr><td>æª¢æŸ¥æ™‚é–“</td><td colspan="2">${new Date(health.checkedAt).toLocaleString('zh-TW')}</td></tr>
                        </table>
                    `;
                    details.innerHTML = detailsHtml;
                } else {
                    dot.className = 'status-dot down';
                    text.textContent = 'ç„¡æ³•é€£ç·š';
                    details.innerHTML = '<p style="color: var(--accent-danger);">ç„¡æ³•é€£æ¥åˆ°ç³»çµ±å¥åº·æª¢æŸ¥æœå‹™</p>';
                }
            } catch (e) {
                console.error("Health check failed", e);
            }
        }
        
        async function fetchData() {
            const data = await api('/holdings/fetch', 'POST');
            if (data.success && data.data) {
                const snapshot = data.data;
                let html = `
                    <div class="alert alert-success">
                        <h3><i class="fas fa-check-circle"></i> è³‡æ–™æŠ“å–æˆåŠŸï¼</h3>
                        <div style="font-size: 0.9rem; margin-top: 8px;">
                            <p><strong>æ—¥æœŸï¼š</strong> ${snapshot.date}</p>
                            <p><strong>æˆåˆ†è‚¡æ•¸é‡ï¼š</strong> ${snapshot.totalCount}</p>
                            <p><strong>ç¸½æ¬Šé‡ï¼š</strong> ${snapshot.totalWeight?.toFixed(2) || '0'}%</p>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin: 16px 0 8px 0;">æ‰€æœ‰æˆåˆ†è‚¡è³‡æ–™</h4>
                        <table>
                            <tr><th>ä»£ç¢¼</th><th>åç¨±</th><th>è‚¡æ•¸</th><th>æ¬Šé‡</th></tr>
                            ${(snapshot.holdings || []).map(h => `
                                <tr>
                                    <td>${h.stockCode}</td>
                                    <td>${h.stockName}</td>
                                    <td class="number">${h.shares?.toLocaleString()}</td>
                                    <td class="number">${h.weight}%</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `;
                document.getElementById('result').innerHTML = html;
                checkHealth();
            } else {
                const errorHtml = `
                    <div class="alert alert-danger">
                        <h3><i class="fas fa-times-circle"></i> æŠ“å–å¤±æ•—</h3>
                        <p>${data.message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                    </div>
                `;
                document.getElementById('result').innerHTML = errorHtml;
            }
            showResult();
        }
        
        async function getLatest() {
            const data = await api('/holdings/latest');
            if (data.success && data.data) {
                const snapshot = data.data;
                let html = `<h3>ğŸ“… ${snapshot.date} æŒå€‰è³‡æ–™</h3>`;
                html += `<p style="color: var(--text-secondary); margin-bottom: 16px;">æˆåˆ†è‚¡æ•¸é‡: ${snapshot.totalCount}</p>`;
                html += '<table><tr><th>ä»£ç¢¼</th><th>åç¨±</th><th>è‚¡æ•¸</th><th>æ¬Šé‡</th></tr>';
                (snapshot.holdings || []).forEach(h => {
                    html += `<tr><td>${h.stockCode}</td><td>${h.stockName}</td><td class="number">${h.shares?.toLocaleString()}</td><td class="number">${h.weight}%</td></tr>`;
                });
                html += '</table>';
                document.getElementById('result').innerHTML = html;
            } else {
                renderResult(data.message ? data : { message: 'å°šç„¡è³‡æ–™ï¼Œè«‹å…ˆæŠ“å–' });
            }
            showResult();
        }
        
        async function loadDates() {
            const select = document.getElementById('dateSelect');
            const startSelect = document.getElementById('startDateSelect');
            const endSelect = document.getElementById('endDateSelect');
            
            // Don't show loading for this background task
            try {
                const response = await fetch(`${API_BASE}/holdings/dates`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.availableDates) {
                    const dates = data.data.availableDates;
                    const options = dates.map(date => `<option value="${date}">${date}</option>`).join('');
                    
                    select.innerHTML = options;
                    startSelect.innerHTML = options;
                    endSelect.innerHTML = options;
                    
                    if (dates.length >= 2) {
                        startSelect.selectedIndex = 1; // æ˜¨å¤©
                        endSelect.selectedIndex = 0;   // ä»Šå¤©
                    }
                    
                    if (dates.length === 0) {
                        const noData = '<option value="">ç„¡å¯ç”¨æ—¥æœŸ</option>';
                        select.innerHTML = noData;
                        startSelect.innerHTML = noData;
                        endSelect.innerHTML = noData;
                    }
                } else {
                    const error = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                    select.innerHTML = error;
                    startSelect.innerHTML = error;
                    endSelect.innerHTML = error;
                }
            } catch (e) {
                console.error("Load dates failed", e);
            }
        }

        async function compareRange() {
            const startDate = document.getElementById('startDateSelect').value;
            const endDate = document.getElementById('endDateSelect').value;
            
            if (!startDate || !endDate) {
                alert('è«‹é¸æ“‡èµ·å§‹èˆ‡çµæŸæ—¥æœŸ');
                return;
            }
            
            const data = await api(`/holdings/compare?startDate=${startDate}&endDate=${endDate}`);
            
            if (data.success && data.data) {
                const result = data.data;
                let html = `<h3>ğŸ“Š å€é–“æ¯”è¼ƒ: ${result.startDate} -> ${result.endDate}</h3>`;
                
                // æ‘˜è¦
                html += `<div style="display: flex; gap: 16px; margin: 16px 0; flex-wrap: wrap;">
                    <div style="display:flex; align-items:center; gap:6px;"><span class="status-dot up"></span> æ–°é€²: ${result.newAdditions.length}</div>
                    <div style="display:flex; align-items:center; gap:6px;"><span class="status-dot down"></span> å‰”é™¤: ${result.removals.length}</div>
                    <div style="display:flex; align-items:center; gap:6px;"><span class="status-dot degraded"></span> å¢æŒ: ${result.increased.length}</div>
                    <div style="display:flex; align-items:center; gap:6px;"><span class="status-dot up" style="background-color:var(--accent-success);"></span> æ¸›æŒ: ${result.decreased.length}</div>
                </div>`;
                
                // æ–°é€²
                if (result.newAdditions.length > 0) {
                    html += `<h4 style="color: var(--accent-danger); margin-top: 24px;">ğŸ”¥ æ–°é€²æˆåˆ†è‚¡ (${result.newAdditions.length})</h4>`;
                    html += renderChangeTable(result.newAdditions, 'new');
                }
                
                // å‰”é™¤
                if (result.removals.length > 0) {
                    html += `<h4 style="color: var(--accent-success); margin-top: 24px;">ğŸ—‘ï¸ å‰”é™¤æˆåˆ†è‚¡ (${result.removals.length})</h4>`;
                    html += renderChangeTable(result.removals, 'removed');
                }
                
                // å¢æŒ
                if (result.increased.length > 0) {
                    html += `<h4 style="color: var(--accent-danger); margin-top: 24px;">ğŸ“ˆ å¢æŒ (${result.increased.length})</h4>`;
                    html += renderChangeTable(result.increased, 'increased');
                }
                
                // æ¸›æŒ
                if (result.decreased.length > 0) {
                    html += `<h4 style="color: var(--accent-success); margin-top: 24px;">ğŸ“‰ æ¸›æŒ (${result.decreased.length})</h4>`;
                    html += renderChangeTable(result.decreased, 'decreased');
                }
                
                document.getElementById('result').innerHTML = html;
            } else {
                renderResult(data.message ? data : { message: 'æ¯”è¼ƒå¤±æ•—' });
            }
            showResult();
        }
        
        function renderChangeTable(list, type) {
            let html = '<table><tr><th>ä»£ç¢¼</th><th>åç¨±</th><th>è®Šå‹•è‚¡æ•¸</th><th>è®Šå‹•æ¯”ä¾‹</th><th>æ¬Šé‡è®ŠåŒ–</th></tr>';
            list.forEach(item => {
                const diffClass = item.sharesDiff > 0 ? 'increase' : (item.sharesDiff < 0 ? 'decrease' : '');
                const diffSign = item.sharesDiff > 0 ? '+' : '';
                const weightSign = item.weightDiff > 0 ? '+' : '';
                
                html += `<tr>
                    <td>${item.stockCode}</td>
                    <td>${item.stockName}</td>
                    <td class="${diffClass} number">${diffSign}${item.sharesDiff?.toLocaleString() || '-'}</td>
                    <td class="${diffClass} number">${item.changeRatio != null ? item.changeRatio + '%' : '-'}</td>
                    <td class="number">${weightSign}${item.weightDiff}%</td>
                </tr>`;
            });
            html += '</table>';
            return html;
        }

        async function getByDate() {
            const date = document.getElementById('dateSelect').value;
            if (!date) {
                alert('è«‹å…ˆé¸æ“‡æ—¥æœŸ');
                return;
            }
            
            const data = await api(`/holdings/${date}`);
            if (data.success && data.data) {
                const snapshot = data.data;
                let html = `<h3>ğŸ“… ${snapshot.date} æŒå€‰è³‡æ–™</h3>`;
                html += `<p style="color: var(--text-secondary); margin-bottom: 16px;">æˆåˆ†è‚¡æ•¸é‡: ${snapshot.totalCount}</p>`;
                html += '<table><tr><th>ä»£ç¢¼</th><th>åç¨±</th><th>è‚¡æ•¸</th><th>æ¬Šé‡</th></tr>';
                (snapshot.holdings || []).forEach(h => {
                    html += `<tr><td>${h.stockCode}</td><td>${h.stockName}</td><td class="number">${h.shares?.toLocaleString()}</td><td class="number">${h.weight}%</td></tr>`;
                });
                html += '</table>';
                document.getElementById('result').innerHTML = html;
            } else {
                renderResult(data.message ? data : { message: 'æŸ¥ç„¡è³‡æ–™' });
            }
            showResult();
        }
        
        async function previewCleanup() {
            const data = await api('/holdings/cleanup?daysToKeep=90&confirm=false', 'DELETE');
            
            if (data.success && data.data) {
                const result = data.data;
                const hasExpired = result.deletedRecords > 0;
                
                let html = `
                    <div class="alert alert-warning">
                        <h3><i class="fas fa-search"></i> æ¸…ç†é è¦½</h3>
                        <div style="font-size: 0.9rem;">
                            <p><strong>ä¿ç•™å¤©æ•¸ï¼š</strong> ${result.remainingDays} å¤©</p>
                            <p><strong>æˆªæ­¢æ—¥æœŸï¼š</strong> ${result.cutoffDate || 'ç„¡'}</p>
                            <p><strong>å°‡è¦åˆªé™¤çš„è¨˜éŒ„æ•¸ï¼š</strong> <span style="font-size: 1.1rem; font-weight: bold; color: var(--accent-danger);">${result.deletedRecords}</span></p>
                            <p><strong>åˆªé™¤å¾Œå°‡å‰©é¤˜çš„è¨˜éŒ„æ•¸ï¼š</strong> ${result.remainingRecords}</p>
                        </div>
                    </div>
                `;
                
                if (hasExpired) {
                    html += `
                        <div class="alert alert-danger">
                            <h4><i class="fas fa-exclamation-triangle"></i> å³å°‡åˆªé™¤éæœŸè³‡æ–™</h4>
                            <p>
                                æ‚¨æœ‰ <strong>${result.deletedRecords}</strong> ç­†éæœŸè³‡æ–™å³å°‡è¢«åˆªé™¤ã€‚<br>
                                é»æ“Šä¸‹æ–¹ã€Œç¢ºèªæ¸…ç†ã€æŒ‰éˆ•ä»¥ç¹¼çºŒé€²è¡Œåˆªé™¤æ“ä½œã€‚
                            </p>
                        </div>
                    `;
                    document.getElementById('confirmCleanupBtn').style.display = 'inline-flex';
                } else {
                    html += `
                        <div class="alert alert-success">
                            <h4><i class="fas fa-check-circle"></i> ç„¡éœ€æ¸…ç†</h4>
                            <p>
                                æ‰€æœ‰è³‡æ–™éƒ½åœ¨ä¿ç•™æœŸé™å…§ï¼Œç„¡éœ€é€²è¡Œæ¸…ç†æ“ä½œã€‚
                            </p>
                        </div>
                    `;
                    document.getElementById('confirmCleanupBtn').style.display = 'none';
                }
                
                document.getElementById('result').innerHTML = html;
            } else {
                const errorHtml = `
                    <div class="alert alert-danger">
                        <h3><i class="fas fa-times-circle"></i> é è¦½å¤±æ•—</h3>
                        <p>${data.message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                    </div>
                `;
                document.getElementById('result').innerHTML = errorHtml;
            }
            showResult();
        }
        
        async function confirmCleanup() {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤éæœŸè³‡æ–™ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            
            const data = await api('/holdings/cleanup?daysToKeep=90&confirm=true', 'DELETE');
            
            document.getElementById('confirmCleanupBtn').style.display = 'none';
            
            if (data.success && data.data) {
                const result = data.data;
                
                let html = `
                    <div class="alert alert-success">
                        <h3><i class="fas fa-check-circle"></i> æ¸…ç†å®Œæˆ</h3>
                        <div style="font-size: 0.9rem;">
                            <p><strong>å·²åˆªé™¤çš„è¨˜éŒ„æ•¸ï¼š</strong> <span style="font-weight: bold;">${result.deletedRecords}</span></p>
                            <p><strong>æˆªæ­¢æ—¥æœŸï¼š</strong> ${result.cutoffDate || 'ç„¡'}</p>
                            <p><strong>åˆªé™¤å¾Œå‰©é¤˜çš„è¨˜éŒ„æ•¸ï¼š</strong> ${result.remainingRecords}</p>
                            <p><strong>æ“ä½œæ™‚é–“ï¼š</strong> ${new Date(result.executedAt).toLocaleString('zh-TW')}</p>
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        <p>${result.message}</p>
                    </div>
                `;
                
                document.getElementById('result').innerHTML = html;
                
                if (result.success) {
                    loadDates();
                }
            } else {
                const errorHtml = `
                    <div class="alert alert-danger">
                        <h3><i class="fas fa-times-circle"></i> æ¸…ç†å¤±æ•—</h3>
                        <p>${data.message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                    </div>
                `;
                document.getElementById('result').innerHTML = errorHtml;
            }
            showResult();
        }
        
        checkHealth();
        loadDates();
        setInterval(checkHealth, 300000);
    </script>
</body>
</html>
