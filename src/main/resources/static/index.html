<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF 00981A æŒå€‰è¿½è¹¤ç³»çµ±</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { 
            color: white; 
            text-align: center; 
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 24px; 
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .card h2 { 
            color: #333; 
            margin-bottom: 16px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd6; transform: translateY(-2px); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        #result {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .status { padding: 8px 16px; border-radius: 20px; display: inline-block; margin: 8px 0; }
        .status-up { background: #d4edda; color: #155724; }
        .status-degraded { background: #fff3cd; color: #856404; }
        .status-down { background: #f8d7da; color: #721c24; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: 600; }
        tr:hover { background: #f5f5f5; }
        
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.active { display: block; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .increase { color: #dc3545; font-weight: bold; }
        .decrease { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ˆ ETF 00981A æŒå€‰è¿½è¹¤ç³»çµ±</h1>
        
        <div class="card">
            <h2>ğŸ”„ ç³»çµ±ç‹€æ…‹</h2>
            <div id="healthStatus">è¼‰å…¥ä¸­...</div>
        </div>
        
        <div class="card">
            <h2>ğŸ“Š æ“ä½œé¢æ¿</h2>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="fetchData()">ğŸ”„ æŠ“å–æœ€æ–°è³‡æ–™</button>
                <button class="btn btn-success" onclick="getLatest()">ğŸ“‹ æŸ¥çœ‹æœ€æ–°æŒå€‰</button>
                <select id="dateSelect" class="btn" style="background: white; border: 1px solid #ddd; color: #333; min-width: 150px;">
                    <option value="">è¼‰å…¥æ—¥æœŸä¸­...</option>
                </select>
                <button class="btn btn-primary" onclick="getByDate()">ğŸ“… æŸ¥è©¢æŒ‡å®šæ—¥æœŸ</button>
                <button class="btn btn-warning" onclick="previewCleanup()">ğŸ—‘ï¸ é è¦½æ¸…ç†</button>
                <button class="btn btn-danger" onclick="confirmCleanup()" style="display:none;" id="confirmCleanupBtn">âŒ ç¢ºèªæ¸…ç†</button>
            </div>
            
            <div class="compare-section" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee;">
                <h3>ğŸ“‰ å€é–“æ¯”è¼ƒ</h3>
                <div class="btn-group" style="margin-top: 12px; align-items: center;">
                    <label>èµ·å§‹ï¼š<select id="startDateSelect" class="btn" style="background: white; border: 1px solid #ddd; padding: 8px;"></select></label>
                    <label>çµæŸï¼š<select id="endDateSelect" class="btn" style="background: white; border: 1px solid #ddd; padding: 8px;"></select></label>
                    <button id="compareBtn" class="btn btn-primary" onclick="compareRange()">ğŸ“Š é–‹å§‹æ¯”è¼ƒ</button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 12px; color: #666;">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
            </div>
        </div>
        
        <div class="card">
            <h2>ğŸ“ åŸ·è¡Œçµæœ</h2>
            <div id="result">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ“ä½œ</div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        async function api(endpoint, method = 'GET') {
            showLoading(true);
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, { method });
                const data = await response.json();
                return data;
            } catch (error) {
                return { success: false, message: error.message };
            } finally {
                showLoading(false);
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }
        
        function formatJson(obj) {
            return JSON.stringify(obj, null, 2);
        }
        
        function renderResult(data) {
            document.getElementById('result').textContent = formatJson(data);
        }
        
        async function checkHealth() {
            const data = await api('/system/health');
            const container = document.getElementById('healthStatus');
            
            if (data.success && data.data) {
                const health = data.data;
                const statusClass = health.status === 'UP' ? 'status-up' : 
                                   health.status === 'DEGRADED' ? 'status-degraded' : 'status-down';
                container.innerHTML = `
                    <span class="status ${statusClass}">${health.status}</span>
                    <table>
                        <tr><th>å…ƒä»¶</th><th>ç‹€æ…‹</th><th>è¨Šæ¯</th></tr>
                        ${Object.entries(health.components || {}).map(([key, comp]) => `
                            <tr>
                                <td>${comp.name || key}</td>
                                <td>${comp.status}</td>
                                <td>${comp.message || '-'}</td>
                            </tr>
                        `).join('')}
                        <tr><td>ç¸½è¨˜éŒ„æ•¸</td><td colspan="2">${health.totalRecords}</td></tr>
                        <tr><td>æª¢æŸ¥æ™‚é–“</td><td colspan="2">${new Date(health.checkedAt).toLocaleString('zh-TW')}</td></tr>
                    </table>
                `;
            } else {
                container.innerHTML = '<span class="status status-down">ç„¡æ³•é€£ç·š</span>';
            }
        }
        
        async function fetchData() {
            const data = await api('/holdings/fetch', 'POST');
            if (data.success && data.data) {
                const snapshot = data.data;
                let html = `
                    <div style="background: #d4edda; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #155724; margin: 0 0 8px 0;">âœ… è³‡æ–™æŠ“å–æˆåŠŸï¼</h3>
                        <div style="color: #155724; font-size: 14px;">
                            <p><strong>æ—¥æœŸï¼š</strong> ${snapshot.date}</p>
                            <p><strong>æˆåˆ†è‚¡æ•¸é‡ï¼š</strong> ${snapshot.totalCount}</p>
                            <p><strong>ç¸½æ¬Šé‡ï¼š</strong> ${snapshot.totalWeight?.toFixed(2) || '0'}%</p>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-top: 0;">å‰ 10 ç­†æˆåˆ†è‚¡è³‡æ–™</h4>
                        <table>
                            <tr><th>ä»£ç¢¼</th><th>åç¨±</th><th>è‚¡æ•¸</th><th>æ¬Šé‡</th></tr>
                            ${(snapshot.holdings || []).slice(0, 10).map(h => `
                                <tr>
                                    <td>${h.stockCode}</td>
                                    <td>${h.stockName}</td>
                                    <td style="text-align: right;">${h.shares?.toLocaleString()}</td>
                                    <td style="text-align: right;">${h.weight}%</td>
                                </tr>
                            `).join('')}
                        </table>
                        ${snapshot.holdings && snapshot.holdings.length > 10 ? `
                            <p style="color: #666; font-size: 12px; margin-top: 8px; font-style: italic;">
                                â€» å…±æœ‰ ${snapshot.totalCount} ç­†è³‡æ–™ï¼Œåƒ…é¡¯ç¤ºå‰ 10 ç­†
                            </p>
                        ` : ''}
                    </div>
                `;
                document.getElementById('result').innerHTML = html;
                checkHealth();
            } else {
                const errorHtml = `
                    <div style="background: #f8d7da; padding: 16px; border-radius: 8px;">
                        <h3 style="color: #721c24; margin: 0 0 8px 0;">âŒ æŠ“å–å¤±æ•—</h3>
                        <p style="color: #721c24; margin: 0;">${data.message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                    </div>
                `;
                document.getElementById('result').innerHTML = errorHtml;
            }
        }
        
        async function getLatest() {
            const data = await api('/holdings/latest');
            if (data.success && data.data) {
                const snapshot = data.data;
                let html = `<h3>ğŸ“… ${snapshot.date} æŒå€‰è³‡æ–™</h3>`;
                html += `<p>æˆåˆ†è‚¡æ•¸é‡: ${snapshot.totalCount}</p>`;
                html += '<table><tr><th>ä»£ç¢¼</th><th>åç¨±</th><th>è‚¡æ•¸</th><th>æ¬Šé‡</th></tr>';
                (snapshot.holdings || []).forEach(h => {
                    html += `<tr><td>${h.stockCode}</td><td>${h.stockName}</td><td>${h.shares?.toLocaleString()}</td><td>${h.weight}%</td></tr>`;
                });
                html += '</table>';
                document.getElementById('result').innerHTML = html;
            } else {
                renderResult(data.message ? data : { message: 'å°šç„¡è³‡æ–™ï¼Œè«‹å…ˆæŠ“å–' });
            }
        }
        
        async function loadDates() {
            const select = document.getElementById('dateSelect');
            const startSelect = document.getElementById('startDateSelect');
            const endSelect = document.getElementById('endDateSelect');
            
            const data = await api('/holdings/dates');
            
            if (data.success && data.data && data.data.availableDates) {
                const dates = data.data.availableDates;
                const options = dates.map(date => `<option value="${date}">${date}</option>`).join('');
                
                select.innerHTML = options;
                startSelect.innerHTML = options;
                endSelect.innerHTML = options;
                
                if (dates.length >= 2) {
                    // é è¨­é¸å–æœ€è¿‘å…©å¤©
                    startSelect.selectedIndex = 1; // æ˜¨å¤©
                    endSelect.selectedIndex = 0;   // ä»Šå¤©
                }
                
                if (dates.length === 0) {
                    const noData = '<option value="">ç„¡å¯ç”¨æ—¥æœŸ</option>';
                    select.innerHTML = noData;
                    startSelect.innerHTML = noData;
                    endSelect.innerHTML = noData;
                }
            } else {
                const error = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                select.innerHTML = error;
                startSelect.innerHTML = error;
                endSelect.innerHTML = error;
            }
        }

        async function compareRange() {
            const startDate = document.getElementById('startDateSelect').value;
            const endDate = document.getElementById('endDateSelect').value;
            
            if (!startDate || !endDate) {
                alert('è«‹é¸æ“‡èµ·å§‹èˆ‡çµæŸæ—¥æœŸ');
                return;
            }
            
            const data = await api(`/holdings/compare?startDate=${startDate}&endDate=${endDate}`);
            
            if (data.success && data.data) {
                const result = data.data;
                let html = `<h3>ğŸ“Š å€é–“æ¯”è¼ƒ: ${result.startDate} -> ${result.endDate}</h3>`;
                
                // æ‘˜è¦
                html += `<div style="display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
                    <span class="status status-up">æ–°é€²: ${result.newAdditions.length}</span>
                    <span class="status status-down">å‰”é™¤: ${result.removals.length}</span>
                    <span class="status status-degraded">å¢æŒ: ${result.increased.length}</span>
                    <span class="status status-up">æ¸›æŒ: ${result.decreased.length}</span>
                </div>`;
                
                // æ–°é€²
                if (result.newAdditions.length > 0) {
                    html += `<h4 style="color: #d32f2f; margin-top: 16px;">ğŸ”¥ æ–°é€²æˆåˆ†è‚¡ (${result.newAdditions.length})</h4>`;
                    html += renderChangeTable(result.newAdditions, 'new');
                }
                
                // å‰”é™¤
                if (result.removals.length > 0) {
                    html += `<h4 style="color: #388e3c; margin-top: 16px;">ğŸ—‘ï¸ å‰”é™¤æˆåˆ†è‚¡ (${result.removals.length})</h4>`;
                    html += renderChangeTable(result.removals, 'removed');
                }
                
                // å¢æŒ
                if (result.increased.length > 0) {
                    html += `<h4 style="color: #d32f2f; margin-top: 16px;">ğŸ“ˆ å¢æŒ (${result.increased.length})</h4>`;
                    html += renderChangeTable(result.increased, 'increased');
                }
                
                // æ¸›æŒ
                if (result.decreased.length > 0) {
                    html += `<h4 style="color: #388e3c; margin-top: 16px;">ğŸ“‰ æ¸›æŒ (${result.decreased.length})</h4>`;
                    html += renderChangeTable(result.decreased, 'decreased');
                }
                
                document.getElementById('result').innerHTML = html;
            } else {
                renderResult(data.message ? data : { message: 'æ¯”è¼ƒå¤±æ•—' });
            }
        }
        
        function renderChangeTable(list, type) {
            let html = '<table><tr><th>ä»£ç¢¼</th><th>åç¨±</th><th>è®Šå‹•è‚¡æ•¸</th><th>è®Šå‹•æ¯”ä¾‹</th><th>æ¬Šé‡è®ŠåŒ–</th></tr>';
            list.forEach(item => {
                const diffClass = item.sharesDiff > 0 ? 'increase' : (item.sharesDiff < 0 ? 'decrease' : '');
                const diffSign = item.sharesDiff > 0 ? '+' : '';
                const weightSign = item.weightDiff > 0 ? '+' : '';
                
                html += `<tr>
                    <td>${item.stockCode}</td>
                    <td>${item.stockName}</td>
                    <td class="${diffClass}">${diffSign}${item.sharesDiff?.toLocaleString() || '-'}</td>
                    <td class="${diffClass}">${item.changeRatio != null ? item.changeRatio + '%' : '-'}</td>
                    <td>${weightSign}${item.weightDiff}%</td>
                </tr>`;
            });
            html += '</table>';
            return html;
        }

        async function getByDate() {
            const date = document.getElementById('dateSelect').value;
            if (!date) {
                alert('è«‹å…ˆé¸æ“‡æ—¥æœŸ');
                return;
            }
            
            const data = await api(`/holdings/${date}`);
            if (data.success && data.data) {
                const snapshot = data.data;
                let html = `<h3>ğŸ“… ${snapshot.date} æŒå€‰è³‡æ–™</h3>`;
                html += `<p>æˆåˆ†è‚¡æ•¸é‡: ${snapshot.totalCount}</p>`;
                html += '<table><tr><th>ä»£ç¢¼</th><th>åç¨±</th><th>è‚¡æ•¸</th><th>æ¬Šé‡</th></tr>';
                (snapshot.holdings || []).forEach(h => {
                    html += `<tr><td>${h.stockCode}</td><td>${h.stockName}</td><td>${h.shares?.toLocaleString()}</td><td>${h.weight}%</td></tr>`;
                });
                html += '</table>';
                document.getElementById('result').innerHTML = html;
            } else {
                renderResult(data.message ? data : { message: 'æŸ¥ç„¡è³‡æ–™' });
            }
        }
        
        async function previewCleanup() {
            const data = await api('/holdings/cleanup?daysToKeep=90&confirm=false', 'DELETE');
            
            if (data.success && data.data) {
                const result = data.data;
                const hasExpired = result.deletedRecords > 0;
                
                let html = `
                    <div style="background: #fff3cd; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #856404; margin: 0 0 8px 0;">ğŸ” æ¸…ç†é è¦½</h3>
                        <div style="color: #856404; font-size: 14px;">
                            <p><strong>ä¿ç•™å¤©æ•¸ï¼š</strong> ${result.remainingDays} å¤©</p>
                            <p><strong>æˆªæ­¢æ—¥æœŸï¼š</strong> ${result.cutoffDate || 'ç„¡'}</p>
                            <p><strong>å°‡è¦åˆªé™¤çš„è¨˜éŒ„æ•¸ï¼š</strong> <span style="font-size: 16px; font-weight: bold; color: #d32f2f;">${result.deletedRecords}</span></p>
                            <p><strong>åˆªé™¤å¾Œå°‡å‰©é¤˜çš„è¨˜éŒ„æ•¸ï¼š</strong> ${result.remainingRecords}</p>
                        </div>
                    </div>
                `;
                
                if (hasExpired) {
                    html += `
                        <div style="background: #f0f0f0; padding: 16px; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <h4 style="color: #333; margin-top: 0;">âš ï¸ å³å°‡åˆªé™¤éæœŸè³‡æ–™</h4>
                            <p style="color: #666; margin: 0;">
                                æ‚¨æœ‰ <strong>${result.deletedRecords}</strong> ç­†éæœŸè³‡æ–™å³å°‡è¢«åˆªé™¤ã€‚<br>
                                é»æ“Šä¸‹æ–¹ã€ŒâŒ ç¢ºèªæ¸…ç†ã€æŒ‰éˆ•ä»¥ç¹¼çºŒé€²è¡Œåˆªé™¤æ“ä½œã€‚
                            </p>
                        </div>
                    `;
                    // é¡¯ç¤ºç¢ºèªæ¸…ç†æŒ‰éˆ•
                    document.getElementById('confirmCleanupBtn').style.display = 'inline-block';
                } else {
                    html += `
                        <div style="background: #d4edda; padding: 16px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <h4 style="color: #155724; margin-top: 0;">âœ… ç„¡éœ€æ¸…ç†</h4>
                            <p style="color: #155724; margin: 0;">
                                æ‰€æœ‰è³‡æ–™éƒ½åœ¨ä¿ç•™æœŸé™å…§ï¼Œç„¡éœ€é€²è¡Œæ¸…ç†æ“ä½œã€‚
                            </p>
                        </div>
                    `;
                    // éš±è—ç¢ºèªæ¸…ç†æŒ‰éˆ•
                    document.getElementById('confirmCleanupBtn').style.display = 'none';
                }
                
                document.getElementById('result').innerHTML = html;
            } else {
                const errorHtml = `
                    <div style="background: #f8d7da; padding: 16px; border-radius: 8px;">
                        <h3 style="color: #721c24; margin: 0 0 8px 0;">âŒ é è¦½å¤±æ•—</h3>
                        <p style="color: #721c24; margin: 0;">${data.message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                    </div>
                `;
                document.getElementById('result').innerHTML = errorHtml;
            }
        }
        
        async function confirmCleanup() {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤éæœŸè³‡æ–™ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            
            const data = await api('/holdings/cleanup?daysToKeep=90&confirm=true', 'DELETE');
            
            // æ¸…ç†å®Œæˆå¾Œï¼Œéš±è—ã€Œç¢ºèªæ¸…ç†ã€æŒ‰éˆ•
            document.getElementById('confirmCleanupBtn').style.display = 'none';
            
            if (data.success && data.data) {
                const result = data.data;
                
                let html = `
                    <div style="background: #d4edda; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #155724; margin: 0 0 8px 0;">âœ… æ¸…ç†å®Œæˆ</h3>
                        <div style="color: #155724; font-size: 14px;">
                            <p><strong>å·²åˆªé™¤çš„è¨˜éŒ„æ•¸ï¼š</strong> <span style="font-size: 16px; font-weight: bold;">${result.deletedRecords}</span></p>
                            <p><strong>æˆªæ­¢æ—¥æœŸï¼š</strong> ${result.cutoffDate || 'ç„¡'}</p>
                            <p><strong>åˆªé™¤å¾Œå‰©é¤˜çš„è¨˜éŒ„æ•¸ï¼š</strong> ${result.remainingRecords}</p>
                            <p><strong>æ“ä½œæ™‚é–“ï¼š</strong> ${new Date(result.executedAt).toLocaleString('zh-TW')}</p>
                        </div>
                    </div>
                    <div style="background: #f0f0f0; padding: 16px; border-radius: 8px;">
                        <p style="color: #333; margin: 0;">${result.message}</p>
                    </div>
                `;
                
                document.getElementById('result').innerHTML = html;
                
                // åˆªé™¤æˆåŠŸå¾Œé‡æ–°è¼‰å…¥æ—¥æœŸæ¸…å–®
                if (result.success) {
                    loadDates();
                }
            } else {
                const errorHtml = `
                    <div style="background: #f8d7da; padding: 16px; border-radius: 8px;">
                        <h3 style="color: #721c24; margin: 0 0 8px 0;">âŒ æ¸…ç†å¤±æ•—</h3>
                        <p style="color: #721c24; margin: 0;">${data.message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                    </div>
                `;
                document.getElementById('result').innerHTML = errorHtml;
            }
        }
        
        // åˆå§‹åŒ–
        checkHealth();
        loadDates();
        // æ”¹ç‚º 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ï¼Œé¿å…æ—¥èªŒéå¤š
        setInterval(checkHealth, 300000);
    </script>
</body>
</html>
