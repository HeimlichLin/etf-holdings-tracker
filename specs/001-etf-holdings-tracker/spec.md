# Feature Specification: ETF 00981A 每日持倉追蹤系統

**Feature Branch**: `001-etf-holdings-tracker`  
**Created**: 2025-11-26  
**Status**: Draft  
**Input**: 使用者描述: "使用 Java Spring Boot Maven 開發的應用程式，用於追蹤活躍 ETF 00981A 的每日持倉變化。將每日數據與前一日數據進行比較，記錄新增、移除和持倉變動。該程式最多保留 90 天的歷史數據，用於趨勢分析。"

---

## Clarifications

### Session 2025-11-26

- Q: 應用程式架構類型？ → A: Desktop 桌面應用程式（免安裝的執行檔）
- Q: 90 天歷史資料清理觸發時機？ → A: 提供手動清理按鈕，由使用者自行決定何時清理超過 90 天的資料；查詢統計範圍維持 90 天
- Q: 資料抓取失敗時的重試機制？ → A: 自動重試 1-3 次（間隔數秒），若仍失敗則顯示錯誤訊息，由使用者手動再次點擊更新按鈕
- Q: Excel 檔案儲存位置？ → A: 儲存在執行檔所在目錄的子資料夾中（如 `./data/holdings.xlsx`），確保資料可攜式
- Q: 成分股唯一識別方式？ → A: 僅以股票代號作為唯一識別（即使名稱變更仍視為同一股票）
- Q: 網頁資料擷取策略？ → A: 混合策略：優先嘗試 API，若無則 fallback 到 DOM 解析
- Q: 桌面應用程式打包方式？ → A: 使用 jlink + jpackage 產生自帶 JRE 的原生執行檔，讓其他電腦能無痛使用
- Q: 應用程式日誌記錄策略？ → A: 日誌寫入檔案（`./logs/app.log`），介面僅顯示使用者友善的狀態/錯誤訊息
- Q: 資料抓取時的 UI 載入狀態顯示？ → A: 顯示進度條 + 狀態文字（如「正在連線...」「正在解析資料...」）+ 停用更新按鈕，避免重複點擊
- Q: 目標作業系統平台？ → A: 僅 Windows（產生 .exe 或 .msi 安裝檔）
- Q: 自動抓取資料的頻率？ → A: 每天下午 4 點 (16:00) 自動執行抓取任務，同時保留手動抓取功能

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 每日自動排程抓取資料 (Priority: P1)

系統在每天下午 4 點 (16:00) 自動從指定網站抓取 ETF 00981A 的最新成分股資料，並將資料儲存至 Excel 檔案中。

**Why this priority**: 自動化抓取能確保資料的連續性與即時性，減少使用者手動操作的負擔。

**Independent Test**: 可透過調整系統時間或觀察日誌，確認在指定時間點系統自動觸發抓取任務並成功儲存資料。

**Acceptance Scenarios**:

1. **Given** 應用程式正在執行中, **When** 系統時間到達下午 4 點 (16:00), **Then** 系統自動觸發資料抓取任務
2. **Given** 自動抓取任務執行成功, **When** 檢查資料儲存, **Then** Excel 檔案中新增了當日的持倉資料
3. **Given** 自動抓取任務執行失敗, **When** 檢查日誌, **Then** 系統記錄錯誤訊息，但不影響應用程式正常運作

### User Story 2 - 手動更新並抓取最新持倉資料 (Priority: P1)

使用者開啟應用程式後，點選「更新」按鈕，系統自動從指定網站抓取 ETF 00981A 的最新成分股資料（股票代號、股票名稱、股數、持股權重），並將資料儲存至 Excel 檔案中。

**Why this priority**: 提供使用者在自動排程之外，隨時手動更新資料的彈性，特別是在自動抓取失敗或需要即時資料時。

**Independent Test**: 可透過點擊更新按鈕後，確認 Excel 檔案中新增了當日的持倉資料來驗證。

**Acceptance Scenarios**:

1. **Given** 使用者開啟應用程式且網路連線正常, **When** 使用者點選「更新」按鈕, **Then** 系統顯示進度條與狀態文字（如「正在連線...」「正在解析資料...」），停用更新按鈕，完成後顯示成功訊息
2. **Given** 當日資料已存在, **When** 使用者再次點選「更新」按鈕, **Then** 系統提示資料已存在，並詢問是否要覆蓋
3. **Given** 網路連線失敗或資料來源無法存取, **When** 使用者點選「更新」按鈕, **Then** 系統自動重試 1-3 次（間隔數秒），若仍失敗則顯示明確的錯誤訊息，使用者可手動再次點擊更新按鈕重試

---

### User Story 3 - 查看單日持倉資料 (Priority: P1)

使用者可以查看特定日期的持倉資料。預設顯示最新的資料，使用者可透過日曆選單選擇查詢特定日期的歷史資料。

**Why this priority**: 查看資料是使用者最基本的需求，與資料抓取同等重要，構成系統的核心價值。

**Independent Test**: 可透過選擇不同日期，確認顯示對應日期的持倉資料來驗證。

**Acceptance Scenarios**:

1. **Given** 系統有歷史資料, **When** 使用者開啟單日查看頁面, **Then** 預設顯示最新日期的持倉資料
2. **Given** 使用者在單日查看頁面, **When** 使用者透過日曆選擇特定日期, **Then** 系統顯示該日期的完整持倉資料（股票代號、名稱、股數、權重）
3. **Given** 使用者選擇的日期無資料, **When** 系統嘗試載入資料, **Then** 顯示「該日期無資料」提示訊息

---

### User Story 4 - 區間資料比較與增減計算 (Priority: P2)

使用者可以選擇起始日期與結束日期，系統計算並顯示該區間內各成分股的增減變化，包括增減股數、變化比例以及權重變化。減少以綠色並加上負號顯示，增加以紅色顯示。

**Why this priority**: 這是進階分析功能，建立在資料抓取與單日查看的基礎上，提供趨勢洞察價值。

**Independent Test**: 可透過選擇兩個有資料的日期，確認系統正確計算並以顏色區分顯示增減變化。

**Acceptance Scenarios**:

1. **Given** 使用者在區間查詢頁面, **When** 使用者選擇起始與結束日期並確認, **Then** 系統顯示所有成分股在該區間的變化資料
2. **Given** 某成分股在區間內股數增加, **When** 資料顯示時, **Then** 該筆資料的增減欄位以紅色顯示
3. **Given** 某成分股在區間內股數減少, **When** 資料顯示時, **Then** 該筆資料的增減欄位以綠色並加上負號顯示
4. **Given** 使用者選擇的區間兩端日期無資料, **When** 系統嘗試計算, **Then** 顯示適當的錯誤提示

---

### User Story 5 - 區間內新進/剔除/增減持整理 (Priority: P2)

使用者查看區間資料時，系統自動將資料分類整理為：區間內新進的增持、被剔除的減持，以及現有成分股的增減持排序。

**Why this priority**: 這是區間比較功能的延伸，提供更有組織的資訊呈現，幫助使用者快速掌握重點變化。

**Independent Test**: 可透過選擇包含新進與剔除股票的日期區間，確認系統正確分類顯示各區塊。

**Acceptance Scenarios**:

1. **Given** 區間內有新進成分股, **When** 顯示區間分析結果, **Then** 新進成分股列於「新進增持」區塊
2. **Given** 區間內有被剔除成分股, **When** 顯示區間分析結果, **Then** 被剔除成分股列於「剔除減持」區塊
3. **Given** 區間內有持股數量變動的成分股, **When** 顯示區間分析結果, **Then** 變動資料按增減幅度排序顯示於「增減持」區塊

---

### User Story 6 - 現代化響應式使用者介面 (Priority: P3)

應用程式採用先進簡約易操作的視覺風格，版面設計像真正的原生 App，作為 Desktop 桌面應用程式（JavaFX GUI），提供免安裝的可攜式執行檔，可在不同視窗大小下正常顯示。

**Why this priority**: UI/UX 雖然重要，但在核心功能完成後再進行優化更為合理。

**Independent Test**: 可透過在不同裝置或視窗大小下操作，確認介面正常顯示且操作流暢。

**Acceptance Scenarios**:

1. **Given** 使用者使用桌面裝置, **When** 開啟應用程式, **Then** 介面以適合桌面的版面配置顯示
2. **Given** 使用者調整視窗大小, **When** 視窗變窄或變寬, **Then** 介面元素自動調整配置以適應新尺寸
3. **Given** 使用者操作介面, **When** 進行任何操作, **Then** 介面回應流暢，無明顯延遲感

---

### Edge Cases

- 當資料來源網站結構變更時，系統如何處理抓取失敗？
- 當使用者點擊手動清理按鈕時，系統如何確認並執行清理超過 90 天的資料？
- 當 Excel 檔案被其他程式佔用時，系統如何處理儲存失敗？
- 當成分股代號或名稱包含特殊字元時，系統如何正確處理？
- 當同一天重複更新資料時，如何避免資料重複？

---

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須能從指定網址 (ezmoney.com.tw) 抓取 ETF 00981A 的成分股資料，採用混合策略：優先嘗試 API 取得資料，若無可用 API 則 fallback 到 HTML DOM 解析（使用 Jsoup）
- **FR-002**: 系統必須擷取並儲存以下成分股欄位：股票代號、股票名稱、股數、持股權重
- **FR-003**: 系統必須將每日持倉資料持久化儲存至執行檔所在目錄的子資料夾中的 Excel 檔案（如 `./data/holdings.xlsx`），確保資料可攜式
- **FR-004**: 系統查詢統計功能以最近 90 天資料為範圍；系統提供手動清理按鈕，由使用者自行決定何時清理超過 90 天的歷史資料
- **FR-005**: 系統必須提供單日資料查詢功能，預設顯示最新資料
- **FR-006**: 系統必須提供日曆選單供使用者選擇查詢特定日期
- **FR-007**: 系統必須提供區間日期查詢功能，計算兩日期間的持倉變化
- **FR-008**: 系統必須計算並顯示增減股數、變化比例及權重變化
- **FR-009**: 系統必須以紅色顯示增加項目、綠色並加負號顯示減少項目
- **FR-010**: 系統必須自動分類區間內的新進增持、剔除減持及增減持變化
- **FR-011**: 系統必須對增減持資料進行排序顯示
- **FR-012**: 系統必須採用 JavaFX 作為 GUI 框架，使用 jlink + jpackage 打包為自帶 JRE 的 Windows 原生執行檔（.exe 或 .msi），使用者無需預先安裝 Java，介面可適應不同視窗尺寸
- **FR-013**: 系統在資料抓取失敗時必須自動重試 1-3 次（間隔數秒），若仍失敗則顯示明確的錯誤訊息，使用者可手動再次點擊更新按鈕重試
- **FR-014**: 系統必須將詳細日誌寫入檔案（`./logs/app.log`），介面僅顯示使用者友善的狀態與錯誤訊息，不顯示技術細節
- **FR-015**: 系統在資料抓取期間必須顯示進度條與狀態文字（如「正在連線...」「正在解析資料...」），並停用更新按鈕以避免重複點擊
- **FR-016**: 系統必須在每天下午 4 點 (16:00) 自動執行資料抓取任務，並將結果儲存至 Excel 檔案中，此過程不應影響使用者正常操作

### Key Entities

- **成分股 (Holding)**: 代表 ETF 中的單一持股，包含股票代號（唯一識別碼）、股票名稱、股數、持股權重；區間比較時僅以股票代號識別同一股票
- **每日快照 (Daily Snapshot)**: 代表特定日期的完整持倉記錄，包含日期與該日所有成分股資料
- **持倉變化 (Holding Change)**: 代表兩個日期間單一成分股的變化，包含增減股數、變化比例、權重變化、變化類型（新進/剔除/增持/減持）

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者點擊更新按鈕後，可在 10 秒內完成資料抓取與儲存
- **SC-002**: 系統能正確識別並抓取資料來源中的所有成分股資訊
- **SC-003**: 使用者可在 2 秒內完成單日資料查詢並看到結果
- **SC-004**: 使用者可在 3 秒內完成區間比較查詢並看到完整分析結果
- **SC-005**: 區間變化計算的增減股數與權重變化準確率達 100%
- **SC-006**: 介面在 320px 至 1920px 螢幕寬度範圍內均能正常顯示與操作
- **SC-007**: 使用者可透過手動清理按鈕刪除超過 90 天的歷史資料，清理操作需有確認提示

---

## Assumptions

- 目標使用者使用 Windows 作業系統
- 資料來源網站 (ezmoney.com.tw) 的頁面結構相對穩定，不會頻繁變更
- 使用者設備具備穩定的網路連線
- ETF 00981A 的成分股數量在合理範圍內（通常數十至數百檔）
- Excel 檔案格式能滿足 90 天資料儲存需求
- 使用者主要使用繁體中文介面
